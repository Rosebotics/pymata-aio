

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pymata_aio.pymata_core &mdash; pymata_aio  documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="pymata_aio  documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> pymata_aio
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../pymata_aio.html">pymata_aio package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">pymata_aio</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>pymata_aio.pymata_core</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pymata_aio.pymata_core</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Copyright (c) 2015 Alan Yorinks All rights reserved.</span>

<span class="sd">This program is free software; you can redistribute it and/or</span>
<span class="sd">modify it under the terms of the GNU  General Public</span>
<span class="sd">License as published by the Free Software Foundation; either</span>
<span class="sd">version 3 of the License, or (at your option) any later version.</span>

<span class="sd">This library is distributed in the hope that it will be useful,</span>
<span class="sd">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="sd">General Public License for more details.</span>

<span class="sd">You should have received a copy of the GNU General Public</span>
<span class="sd">License along with this library; if not, write to the Free Software</span>
<span class="sd">Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">serial</span>
<span class="kn">from</span> <span class="nn">.constants</span> <span class="kn">import</span> <span class="n">Constants</span>
<span class="kn">from</span> <span class="nn">.private_constants</span> <span class="kn">import</span> <span class="n">PrivateConstants</span>
<span class="kn">from</span> <span class="nn">.pin_data</span> <span class="kn">import</span> <span class="n">PinData</span>
<span class="kn">from</span> <span class="nn">.pymata_serial</span> <span class="kn">import</span> <span class="n">PymataSerial</span>
<span class="kn">from</span> <span class="nn">.pymata_socket</span> <span class="kn">import</span> <span class="n">PymataSocket</span>


<span class="c"># noinspection PyCallingNonCallable,PyCallingNonCallable,PyPep8,PyBroadException,PyBroadException</span>
<div class="viewcode-block" id="PymataCore"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore">[docs]</a><span class="k">class</span> <span class="nc">PymataCore</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class exposes and implements the pymata_core asyncio API,</span>
<span class="sd">    It includes the public API methods as well as</span>
<span class="sd">    a set of private methods. If your application is using asyncio,</span>
<span class="sd">    this is the API that you should use.</span>

<span class="sd">    After instantiating this class, its &quot;start&quot; method MUST be called to</span>
<span class="sd">    perform Arduino pin auto-detection.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arduino_wait</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sleep_tune</span><span class="o">=.</span><span class="mo">001</span><span class="p">,</span> <span class="n">log_output</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">com_port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ip_port</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
                 <span class="n">ip_handshake</span><span class="o">=</span><span class="s">&#39;*HELLO*&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is the &quot;constructor&quot; method for the PymataCore class.</span>

<span class="sd">        If log_output is set to True, a log file called &#39;pymata_log&#39;</span>

<span class="sd">        will be created in the current directory and all pymata_aio output</span>
<span class="sd">        will be redirected to the log with no output appearing on the console.</span>


<span class="sd">        :param arduino_wait: Amount of time to wait for Arduino to reset.</span>
<span class="sd">                             UNO takes 2 seconds, Leonardo can be zero</span>
<span class="sd">        :param sleep_tune: This parameter sets the amount of time PyMata core</span>
<span class="sd">                           uses to set asyncio.sleep</span>
<span class="sd">        :param log_output: If false, all output goes to console, else output</span>
<span class="sd">                           redirected to log file.</span>
<span class="sd">        :param com_port: Manually selected com port - normally it is</span>
<span class="sd">                         auto-detected</span>
<span class="sd">        :param ip_address: If using a WiFly module, set its address here</span>
<span class="sd">        :param ip_port: Port to used with ip_address</span>
<span class="sd">        :param ip_handshake: Connectivity handshake string sent by IP device</span>

<span class="sd">        :returns: This method never returns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># check to make sure that Python interpreter is version 3.5 or greater</span>
        <span class="n">python_version</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span>
        <span class="k">if</span> <span class="n">python_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">python_version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span>
                    <span class="s">&quot;ERROR: Python 3.5 or greater is required for use of this program.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span> <span class="o">=</span> <span class="n">log_output</span>
        <span class="k">if</span> <span class="n">log_output</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s">&#39;./pymata_aio.log&#39;</span><span class="p">,</span> <span class="n">filemode</span><span class="o">=</span><span class="s">&#39;w&#39;</span><span class="p">,</span>
                                <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span> <span class="o">=</span> <span class="n">sleep_tune</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_wait</span> <span class="o">=</span> <span class="n">arduino_wait</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">com_port</span> <span class="o">=</span> <span class="n">com_port</span>
        <span class="k">if</span> <span class="n">ip_address</span> <span class="o">==</span> <span class="s">&#39;None&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ip_address</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ip_address</span> <span class="o">=</span> <span class="n">ip_address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ip_port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ip_port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ip_handshake</span> <span class="o">=</span> <span class="n">ip_handshake</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hall_encoder</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># this dictionary for mapping incoming Firmata message types to</span>
        <span class="c"># handlers for the messages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command_dictionary</span> <span class="o">=</span> <span class="p">{</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_report_version</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_report_firmware</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_RESPONSE</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_capability_response</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_RESPONSE</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_analog_mapping_response</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_RESPONSE</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_pin_state_response</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">STRING_DATA</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_string_data</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MESSAGE</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_analog_message</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">DIGITAL_MESSAGE</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_digital_message</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">I2C_REPLY</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_i2c_reply</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SONAR_DATA</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_sonar_data</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ENCODER_DATA</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_encoder_data</span><span class="p">}</span>

        <span class="c"># report query results are stored in this dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                                 <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">STRING_DATA</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                                 <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                                 <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_RESPONSE</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                                 <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_RESPONSE</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                                 <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_RESPONSE</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>

        <span class="c"># An i2c_map entry consists of a device i2c address as the key, and</span>
        <span class="c">#  the value of the key consists of a dictionary containing 3 entries.</span>
        <span class="c">#  The first entry. &#39;value&#39; contains the last value reported, and</span>
        <span class="c"># the second, &#39;callback&#39; contains a reference to a callback function.</span>
        <span class="c"># the third, callback_type contains the callback type selector</span>
        <span class="c">#  (None = Direct, 1 = await)</span>
        <span class="c"># For example:</span>
        <span class="c"># {12345: {&#39;value&#39;: 23, &#39;callback&#39;: None, &#39;callback_type: None}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># the active_sonar_map maps the sonar trigger pin number (the key)</span>
        <span class="c"># to the current data value returned</span>
        <span class="c"># if a callback was specified, it is stored in the map as well.</span>
        <span class="c"># an entry in the map consists of:</span>
        <span class="c">#   pin: [callback,, callback_type, [current_data_returned]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># The latch_map is a dictionary that stores all latches setup by</span>
        <span class="c"># the user.</span>
        <span class="c"># The key is a string defined as follows:</span>
        <span class="c">#   Digital Pin : D + pin number (D12)</span>
        <span class="c">#   Analog  Pin: A + pin number (A3)</span>

        <span class="c"># The value associated with each key is a list comprised of:</span>

        <span class="c"># [latched_state, threshold_type,</span>
        <span class="c">#  threshold_value, latched_data, time_stamp]</span>

        <span class="c"># latched_state: Each list entry contains a latch state,</span>
        <span class="c">#                a threshold type, a threshold value value the data</span>
        <span class="c">#                value at time of latching,  and a date stamp</span>
        <span class="c">#                when latched.</span>
        <span class="c"># A latch state:</span>

        <span class="c"># LATCH_IGNORE = 0   # this item currently not participating in latching</span>
        <span class="c"># LATCH_ARMED = 1    # When the next item value change is received and,</span>
        <span class="c">#                    # if it matches the latch</span>
        <span class="c">#                    # criteria, the data will be latched</span>
        <span class="c"># LATCH_LATCHED = 2  # data has been latched. Read the data to</span>
        <span class="c">#                    # re-arm the latch</span>

        <span class="c"># threshold type:</span>
        <span class="c">#     LATCH_EQ = 0  data value is equal to the latch threshold value</span>
        <span class="c">#     LATCH_GT = 1  data value is greater than the latch</span>
        <span class="c">#                   threshold value</span>
        <span class="c">#     LATCH_LT = 2  data value is less than the latch threshold value</span>
        <span class="c">#     LATCH_GTE = 3  data value is greater than or equal to the</span>
        <span class="c">#                    latch threshold value</span>
        <span class="c">#     LATCH_LTE = 4 # data value is less than or equal to the</span>
        <span class="c">#                     latch threshold value</span>

        <span class="c"># threshold value: target threshold data value</span>

        <span class="c"># latched data value: value of data at time of latching event</span>

        <span class="c"># time stamp: time of latching event</span>

        <span class="c"># analog_latch_table entry = pin: [latched_state, threshold_type,</span>
        <span class="c">#                            threshold_value, latched_data, time_stamp]</span>
        <span class="c"># digital_latch_table_entry = pin: [latched_state, threshold_type,</span>
        <span class="c">#                                   latched_data, time_stamp]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">latch_map</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span><span class="p">:</span>
            <span class="n">log_string</span> <span class="o">=</span> <span class="s">&#39;pymata_aio Version &#39;</span> <span class="o">+</span> \
                         <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PYMATA_VERSION</span> <span class="o">+</span> \
                         <span class="s">&#39; Copyright (c) 2015 Alan Yorinks All rights reserved.&#39;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_string</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">print</span><span class="p">(</span><span class="s">&#39;{}{}{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;pymata_aio Version &#39;</span> <span class="o">+</span>
                                  <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PYMATA_VERSION</span><span class="p">,</span>
                                  <span class="s">&#39;</span><span class="se">\t</span><span class="s">Copyright (c) 2015 Alan Yorinks All &#39;</span>
                                  <span class="s">&#39;rights reserved.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">com_port</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip_address</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">com_port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_discover_port</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip_address</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span><span class="p">:</span>
                <span class="n">log_string</span> <span class="o">=</span> <span class="s">&#39;Using Ip Address/Port: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip_address</span> <span class="o">+</span> \
                             <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ip_port</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_string</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Using Ip Address/Port: &#39;</span> <span class="o">+</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">ip_address</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip_port</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span> <span class="o">=</span> <span class="n">sleep_tune</span>

        <span class="c"># a list of PinData objects - one for each pin segregate by pin type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">the_task</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># The correct reader and writer methods will be set after</span>
        <span class="c"># the system detects if a serial or socket connection was chosen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">keep_alive_interval</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margin</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c"># set up signal handler for controlC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>

<div class="viewcode-block" id="PymataCore.start"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method must be called immediately after the class is instantiated.</span>
<span class="sd">        It instantiates the serial interface and then performs auto pin</span>
<span class="sd">        discovery.</span>
<span class="sd">        It is intended for use by pymata3 applications that do not</span>
<span class="sd">        use asyncio coroutines directly.</span>

<span class="sd">        :returns: No return value.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># check if user specified a socket transport</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip_address</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">PymataSocket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip_address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip_port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">start</span><span class="p">()))</span>
            <span class="c"># set the read and write handles</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">read</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">write</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip_handshake</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span> <span class="o">=</span> <span class="n">PymataSerial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">com_port</span><span class="p">,</span> <span class="mi">57600</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span><span class="p">)</span>
                <span class="c"># set the read and write handles</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">read</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">write</span>
            <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span><span class="p">:</span>
                    <span class="n">log_string</span> <span class="o">=</span> <span class="s">&#39;Cannot instantiate serial interface: &#39;</span> \
                                 <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">com_port</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">log_string</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span>
                        <span class="s">&#39;Cannot instantiate serial interface: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">com_port</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c"># wait for arduino to go through a reset cycle if need be</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arduino_wait</span><span class="p">)</span>

        <span class="c"># register the get_command method with the event loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">the_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_command_dispatcher</span><span class="p">())</span>

        <span class="c"># get an analog pin map</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_analog_map</span><span class="p">())</span>

        <span class="c"># try to get an analog report. if it comes back as none - shutdown</span>
        <span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_analog_map</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">report</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span><span class="p">:</span>
                <span class="n">log_string</span> <span class="o">=</span> <span class="s">&#39;*** Analog map retrieval timed out. ***&#39;</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">log_string</span><span class="p">)</span>
                <span class="n">log_string</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">Do you have Arduino connectivity and do you &#39;</span> \
                             <span class="s">&#39;have a Firmata sketch uploaded to the board?&#39;</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">log_string</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;*** Analog map retrieval timed out. ***&#39;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Do you have Arduino connectivity and do you have a &#39;</span>
                      <span class="s">&#39;Firmata sketch uploaded to the board?&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="o">.</span><span class="n">all_tasks</span><span class="p">(</span><span class="n">loop</span><span class="p">):</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="o">.</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">loop</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="c"># this suppresses the Event Loop Is Running message, which may</span>
                <span class="c"># be a bug in python 3</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c"># custom assemble the pin lists</span>
        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="n">report</span><span class="p">:</span>
            <span class="n">digital_data</span> <span class="o">=</span> <span class="n">PinData</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">digital_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pin</span> <span class="o">!=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">IGNORE</span><span class="p">:</span>
                <span class="n">analog_data</span> <span class="o">=</span> <span class="n">PinData</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">analog_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span><span class="p">:</span>
            <span class="n">log_string</span> <span class="o">=</span> <span class="s">&#39;Auto-discovery complete. Found &#39;</span> <span class="o">+</span> \
                         <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">))</span> <span class="o">+</span> <span class="s">&#39; Digital Pins and &#39;</span> <span class="o">+</span> \
                         <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">))</span> <span class="o">+</span> <span class="s">&#39; Analog Pins&#39;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_string</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;{} {} {} {} {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;Auto-discovery complete. Found&#39;</span><span class="p">,</span>
                                          <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">),</span>
                                          <span class="s">&#39;Digital Pins and&#39;</span><span class="p">,</span>
                                          <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">),</span>
                                          <span class="s">&#39;Analog Pins</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="PymataCore.start_aio"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.start_aio">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">start_aio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method must be called immediately after the class is instantiated.</span>
<span class="sd">        It instantiates the serial interface and then performs auto pin</span>
<span class="sd">        discovery.</span>
<span class="sd">        It is intended for use by applications that directly uses asyncio.</span>

<span class="sd">        :returns: No return value.</span>
<span class="sd">         &quot;&quot;&quot;</span>

        <span class="c"># pick the desired transport and then setup read and write to</span>
        <span class="c"># point to the correct method for the transport</span>

        <span class="c"># check if user specified a socket transport</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip_address</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">PymataSocket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip_address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip_port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="c"># set the read and write handles</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">read</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">write</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip_handshake</span><span class="p">)):</span>
                <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span> <span class="o">=</span> <span class="n">PymataSerial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">com_port</span><span class="p">,</span> <span class="mi">57600</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span><span class="p">)</span>

                <span class="c"># set the read and write handles</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">read</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">write</span>

            <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span><span class="p">:</span>
                    <span class="n">log_string</span> <span class="o">=</span> <span class="s">&#39;Cannot instantiate serial interface: &#39;</span> <span class="o">+</span> \
                                 <span class="bp">self</span><span class="o">.</span><span class="n">com_port</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">log_string</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span>
                        <span class="s">&#39;Cannot instantiate serial interface: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">com_port</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c"># wait for arduino to go through a reset cycle if need be</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arduino_wait</span><span class="p">)</span>

        <span class="c"># register the get_command method with the event loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">the_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_command_dispatcher</span><span class="p">())</span>

        <span class="c"># get an analog pin map</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_analog_map</span><span class="p">())</span>

        <span class="c"># try to get an analog report. if it comes back as none - shutdown</span>
        <span class="c"># report = await self.get_analog_map()</span>
        <span class="n">report</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_analog_map</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">report</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span><span class="p">:</span>
                <span class="n">log_string</span> <span class="o">=</span> <span class="s">&#39;*** Analog map retrieval timed out. ***&#39;</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">log_string</span><span class="p">)</span>
                <span class="n">log_string</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">Do you have Arduino connectivity and do you &#39;</span> \
                             <span class="s">&#39;have a Firmata sketch uploaded to the board?&#39;</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">log_string</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;*** Analog map retrieval timed out. ***&#39;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Do you have Arduino connectivity and do you have a &#39;</span>
                      <span class="s">&#39;Firmata sketch uploaded to the board?&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="o">.</span><span class="n">all_tasks</span><span class="p">(</span><span class="n">loop</span><span class="p">):</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="o">.</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">loop</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">the_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="c"># this suppresses the Event Loop Is Running message,</span>
                <span class="c"># which may be a bug in python 3.4.3</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c"># custom assemble the pin lists</span>
        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="n">report</span><span class="p">:</span>
            <span class="n">digital_data</span> <span class="o">=</span> <span class="n">PinData</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">digital_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pin</span> <span class="o">!=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">IGNORE</span><span class="p">:</span>
                <span class="n">analog_data</span> <span class="o">=</span> <span class="n">PinData</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">analog_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span><span class="p">:</span>
            <span class="n">log_string</span> <span class="o">=</span> <span class="s">&#39;Auto-discovery complete. Found &#39;</span> <span class="o">+</span> \
                         <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">))</span> <span class="o">+</span> <span class="s">&#39; Digital Pins and &#39;</span> <span class="o">+</span> \
                         <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">))</span> <span class="o">+</span> <span class="s">&#39; Analog Pins&#39;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_string</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;{} {} {} {} {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;Auto-discovery complete. Found&#39;</span><span class="p">,</span>
                                          <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">),</span>
                                          <span class="s">&#39;Digital Pins and&#39;</span><span class="p">,</span>
                                          <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">),</span>
                                          <span class="s">&#39;Analog Pins</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="PymataCore.analog_read"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.analog_read">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">analog_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the last data update for the specified analog pin.</span>

<span class="sd">        :param pin: Analog pin number (ex. A2 is specified as 2)</span>
<span class="sd">        :returns: Last value reported for the analog pin</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">current_value</span>
</div>
<div class="viewcode-block" id="PymataCore.analog_write"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.analog_write">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">analog_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the selected pin to the specified value.</span>

<span class="sd">        :param pin: PWM pin number</span>
<span class="sd">        :param value: Pin value (0 - 0x4000)</span>
<span class="sd">        :returns: No return value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MESSAGE</span> <span class="o">+</span> <span class="n">pin</span> <span class="o">&lt;</span> <span class="mh">0xf0</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MESSAGE</span> <span class="o">+</span> <span class="n">pin</span><span class="p">,</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
                       <span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">]</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">extended_analog</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PymataCore.digital_read"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.digital_read">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">digital_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the last data update for the specified digital pin.</span>

<span class="sd">        :param pin: Digital pin number</span>
<span class="sd">        :returns: Last value reported for the digital pin</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">current_value</span>
</div>
<div class="viewcode-block" id="PymataCore.digital_write"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.digital_write">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">digital_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the specified pin to the specified value.</span>

<span class="sd">        :param pin: pin number</span>
<span class="sd">        :param value: pin value</span>
<span class="sd">        :returns: No return value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># The command value is not a fixed value, but needs to be calculated</span>
        <span class="c"># using the pin&#39;s port number</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">pin</span> <span class="o">//</span> <span class="mi">8</span>

        <span class="n">calculated_command</span> <span class="o">=</span> <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">DIGITAL_MESSAGE</span> <span class="o">+</span> <span class="n">port</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">pin</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span>
        <span class="c"># Calculate the value for the pin&#39;s position in the port mask</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">DIGITAL_OUTPUT_PORT_PINS</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">|=</span> <span class="n">mask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">DIGITAL_OUTPUT_PORT_PINS</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span>

        <span class="c"># Assemble the command</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">(</span><span class="n">calculated_command</span><span class="p">,</span>
                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">DIGITAL_OUTPUT_PORT_PINS</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">DIGITAL_OUTPUT_PORT_PINS</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span>

        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PymataCore.disable_analog_reporting"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.disable_analog_reporting">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">disable_analog_reporting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Disables analog reporting for a single analog pin.</span>

<span class="sd">        :param pin: Analog pin number. For example for A0, the number is 0.</span>
<span class="sd">        :returns: No return value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_ANALOG</span> <span class="o">+</span> <span class="n">pin</span><span class="p">,</span>
                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORTING_DISABLE</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PymataCore.disable_digital_reporting"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.disable_digital_reporting">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">disable_digital_reporting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Disables digital reporting. By turning reporting off for this pin,</span>
<span class="sd">        Reporting is disabled for all 8 bits in the &quot;port&quot;</span>

<span class="sd">        :param pin: Pin and all pins for this port</span>
<span class="sd">        :returns: No return value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">pin</span> <span class="o">//</span> <span class="mi">8</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_DIGITAL</span> <span class="o">+</span> <span class="n">port</span><span class="p">,</span>
                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORTING_DISABLE</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PymataCore.encoder_config"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.encoder_config">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">encoder_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin_a</span><span class="p">,</span> <span class="n">pin_b</span><span class="p">,</span> <span class="n">cb</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cb_type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                             <span class="n">hall_encoder</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This command enables the rotary encoder support and will</span>
<span class="sd">        enable encoder reporting.</span>

<span class="sd">        This command is not part of StandardFirmata. For 2 pin + ground</span>
<span class="sd">        encoders, FirmataPlus is required to be used for 2 pin rotary encoder,</span>
<span class="sd">        and for hell effect wheel encoder support, FirmataPlusRB is required.</span>

<span class="sd">        Encoder data is retrieved by performing a digital_read from pin a</span>
<span class="sd">        (encoder pin_a).</span>

<span class="sd">        When using 2 hall effect sensors (e.g. 2 wheel robot)</span>
<span class="sd">        specify pin_a for 1st encoder and pin_b for 2nd encoder.</span>

<span class="sd">        :param pin_a: Encoder pin 1.</span>
<span class="sd">        :param pin_b: Encoder pin 2.</span>
<span class="sd">        :param cb: callback function to report encoder changes</span>
<span class="sd">        :param cb_type: Constants.CB_TYPE_DIRECT = direct call or</span>
<span class="sd">                        Constants.CB_TYPE_ASYNCIO = asyncio coroutine</span>
<span class="sd">        :param hall_encoder: wheel hall_encoder - set to</span>
<span class="sd">                             True to select hall encoder support support.</span>
<span class="sd">        :returns: No return value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># checked when encoder data is returned</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hall_encoder</span> <span class="o">=</span> <span class="n">hall_encoder</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">pin_a</span><span class="p">,</span> <span class="n">pin_b</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cb</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin_a</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">cb</span>
        <span class="k">if</span> <span class="n">cb_type</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin_a</span><span class="p">]</span><span class="o">.</span><span class="n">cb_type</span> <span class="o">=</span> <span class="n">cb_type</span>

        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ENCODER_CONFIG</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PymataCore.encoder_read"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.encoder_read">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">encoder_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method retrieves the latest encoder data value</span>

<span class="sd">        :param pin: Encoder Pin</span>
<span class="sd">        :returns: encoder data value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">current_value</span>
</div>
<div class="viewcode-block" id="PymataCore.enable_analog_reporting"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.enable_analog_reporting">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">enable_analog_reporting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enables analog reporting. By turning reporting on for a single pin,</span>

<span class="sd">        :param pin: Analog pin number. For example for A0, the number is 0.</span>
<span class="sd">        :returns: No return value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_ANALOG</span> <span class="o">+</span> <span class="n">pin</span><span class="p">,</span>
                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORTING_ENABLE</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PymataCore.enable_digital_reporting"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.enable_digital_reporting">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">enable_digital_reporting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enables digital reporting. By turning reporting on for all 8 bits</span>
<span class="sd">        in the &quot;port&quot; - this is part of Firmata&#39;s protocol specification.</span>

<span class="sd">        :param pin: Pin and all pins for this port</span>
<span class="sd">        :returns: No return value</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">pin</span> <span class="o">//</span> <span class="mi">8</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_DIGITAL</span> <span class="o">+</span> <span class="n">port</span><span class="p">,</span>
                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORTING_ENABLE</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PymataCore.extended_analog"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.extended_analog">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">extended_analog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method will send an extended-data analog write command to the</span>
<span class="sd">        selected pin.</span>

<span class="sd">        :param pin: 0 - 127</span>
<span class="sd">        :param data: 0 - 0xfffff</span>
<span class="sd">        :returns: No return value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">analog_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">pin</span><span class="p">,</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">EXTENDED_ANALOG</span><span class="p">,</span> <span class="n">analog_data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PymataCore.get_analog_latch_data"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.get_analog_latch_data">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_analog_latch_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A list is returned containing the latch state for the pin, the</span>
<span class="sd">        latched value, and the time stamp</span>
<span class="sd">        [latched_state, threshold_type, threshold_value,</span>
<span class="sd">         latched_data, time_stamp]</span>

<span class="sd">        :param pin: Pin number.</span>
<span class="sd">        :returns:  [latched_state, threshold_type, threshold_value,</span>
<span class="sd">                    latched_data, time_stamp]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;A&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">latch_map</span><span class="p">:</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latch_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">entry</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="PymataCore.get_analog_map"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.get_analog_map">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_analog_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method requests a Firmata analog map query and returns the results.</span>

<span class="sd">        :returns: An analog map response or None if a timeout occurs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># get the current time to make sure a report is retrieved</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c"># if we do not have existing report results, send a Firmata</span>
        <span class="c"># message to request one</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_QUERY</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_QUERY</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="c"># wait for the report results to return for 2 seconds</span>
            <span class="c"># if the timer expires, shutdown</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_RESPONSE</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">elapsed_time</span> <span class="o">-</span> <span class="n">current_time</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span>
                <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_RESPONSE</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PymataCore.get_capability_report"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.get_capability_report">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_capability_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method requests and returns a Firmata capability query report</span>

<span class="sd">        :returns: A capability report in the form of a list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_QUERY</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_QUERY</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_RESPONSE</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_RESPONSE</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PymataCore.get_digital_latch_data"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.get_digital_latch_data">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_digital_latch_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A list is returned containing the latch state for the pin, the</span>
<span class="sd">        latched value, and the time stamp</span>
<span class="sd">        [pin_num, latch_state, latched_value, time_stamp]</span>

<span class="sd">        :param pin: Pin number.</span>
<span class="sd">        :returns:  [latched_state, threshold_type, threshold_value,</span>
<span class="sd">                   latched_data, time_stamp]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;D&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">latch_map</span><span class="p">:</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latch_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">entry</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="PymataCore.get_firmware_version"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.get_firmware_version">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_firmware_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method retrieves the Firmata firmware version</span>

<span class="sd">        :returns: Firmata firmware version</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
        <span class="n">reply</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">):</span>
            <span class="n">reply_data</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reply_data</span><span class="p">:</span>
                <span class="n">reply</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">reply_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">]</span> <span class="o">=</span> <span class="n">reply</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PymataCore.get_protocol_version"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.get_protocol_version">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_protocol_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method returns the major and minor values for the protocol</span>
<span class="sd">        version, i.e. 2.4</span>

<span class="sd">        :returns: Firmata protocol version</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">)</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PymataCore.get_pin_state"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.get_pin_state">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_pin_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method retrieves a pin state report for the specified pin</span>

<span class="sd">        :param pin: Pin of interest</span>
<span class="sd">        :returns: pin state report</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pin_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">pin</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_QUERY</span><span class="p">,</span> <span class="n">pin_list</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_RESPONSE</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
        <span class="n">pin_state_report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_RESPONSE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_RESPONSE</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">pin_state_report</span>

    <span class="c"># noinspection PyMethodMayBeStatic</span></div>
<div class="viewcode-block" id="PymataCore.get_pymata_version"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.get_pymata_version">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_pymata_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method retrieves the PyMata version number</span>

<span class="sd">        :returns: PyMata version number.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PYMATA_VERSION</span>
</div>
<div class="viewcode-block" id="PymataCore.i2c_config"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.i2c_config">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">i2c_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read_delay_time</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        NOTE: THIS METHOD MUST BE CALLED BEFORE ANY I2C REQUEST IS MADE</span>
<span class="sd">        This method initializes Firmata for I2c operations.</span>

<span class="sd">        :param read_delay_time (in microseconds): an optional parameter,</span>
<span class="sd">                                                  default is 0</span>
<span class="sd">        :returns: No Return Value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_delay_time</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">read_delay_time</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">I2C_CONFIG</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PymataCore.i2c_read_data"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.i2c_read_data">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">i2c_read_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method retrieves cached i2c data to support a polling mode.</span>

<span class="sd">        :param address: I2C device address</span>
<span class="sd">        :returns: Last cached value read</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="p">:</span>
            <span class="n">map_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">map_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;value&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="PymataCore.i2c_read_request"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.i2c_read_request">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">i2c_read_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">register</span><span class="p">,</span> <span class="n">number_of_bytes</span><span class="p">,</span>
                               <span class="n">read_type</span><span class="p">,</span> <span class="n">cb</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cb_type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method requests the read of an i2c device. Results are retrieved</span>
<span class="sd">        by a call to i2c_get_read_data(). or by callback.</span>

<span class="sd">        If a callback method is provided, when data is received from the</span>
<span class="sd">        device it will be sent to the callback method.</span>
<span class="sd">        Some devices require that transmission be restarted</span>
<span class="sd">        (e.g. MMA8452Q accelerometer).</span>
<span class="sd">        Use Constants.I2C_READ | Constants.I2C_RESTART_TX for those cases.</span>

<span class="sd">        :param address: i2c device address</span>
<span class="sd">        :param register: register number (can be set to zero)</span>
<span class="sd">        :param number_of_bytes: number of bytes expected to be returned</span>
<span class="sd">        :param read_type: I2C_READ  or I2C_READ_CONTINUOUSLY. I2C_RESTART_TX</span>
<span class="sd">                          may be OR&#39;ed when required</span>
<span class="sd">        :param cb: Optional callback function to report i2c data as a</span>
<span class="sd">                   result of read command</span>
<span class="sd">        :param cb_type: Constants.CB_TYPE_DIRECT = direct call or</span>
<span class="sd">                        Constants.CB_TYPE_ASYNCIO = asyncio coroutine</span>
<span class="sd">        :returns: No return value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">address</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="p">:</span>
            <span class="c"># self.i2c_map[address] = [None, cb]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;value&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;callback&#39;</span><span class="p">:</span> <span class="n">cb</span><span class="p">,</span>
                                     <span class="s">&#39;callback_type&#39;</span><span class="p">:</span> <span class="n">cb_type</span><span class="p">}</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">address</span><span class="p">,</span> <span class="n">read_type</span><span class="p">,</span> <span class="n">register</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">register</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">,</span>
                <span class="n">number_of_bytes</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">number_of_bytes</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">I2C_REQUEST</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PymataCore.i2c_write_request"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.i2c_write_request">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">i2c_write_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write data to an i2c device.</span>

<span class="sd">        :param address: i2c device address</span>
<span class="sd">        :param args: A variable number of bytes to be sent to the device</span>
<span class="sd">                     passed in as a list</span>
<span class="sd">        :returns: No return value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">address</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">I2C_WRITE</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">item_lsb</span> <span class="o">=</span> <span class="n">item</span> <span class="o">&amp;</span> <span class="mh">0x7f</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_lsb</span><span class="p">)</span>
            <span class="n">item_msb</span> <span class="o">=</span> <span class="n">item</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_msb</span><span class="p">)</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">I2C_REQUEST</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PymataCore.keep_alive"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.keep_alive">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">keep_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">margin</span><span class="o">=.</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Periodically send a keep alive message to the Arduino.</span>
<span class="sd">        Frequency of keep alive transmission is calculated as follows:</span>
<span class="sd">        keep_alive_sent = period - (period * margin)</span>


<span class="sd">        :param period: Time period between keepalives. Range is 0-10 seconds. 0 disables the keepalive mechanism.</span>
<span class="sd">        :param margin: Safety margin to assure keepalives are sent before period expires. Range is 0.1 to 0.9</span>
<span class="sd">        :returns: No return value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">period</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">period</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">period</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">period</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="k">if</span> <span class="n">margin</span> <span class="o">&lt;</span> <span class="o">.</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">margin</span> <span class="o">=</span> <span class="o">.</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">margin</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">9</span><span class="p">:</span>
            <span class="n">margin</span> <span class="o">=</span> <span class="o">.</span><span class="mi">9</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margin</span> <span class="o">=</span> <span class="n">margin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_alive_interval</span> <span class="o">=</span> <span class="p">[</span><span class="n">period</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">period</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SAMPLING_INTERVAL</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">keep_alive_interval</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
                <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">period</span> <span class="o">-</span> <span class="p">(</span><span class="n">period</span> <span class="o">-</span> <span class="p">(</span><span class="n">period</span> <span class="o">*</span> <span class="n">margin</span><span class="p">)))</span>
                <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">KEEP_ALIVE</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">keep_alive_interval</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
</div>
<div class="viewcode-block" id="PymataCore.play_tone"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.play_tone">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">play_tone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">tone_command</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">duration</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method will call the Tone library for the selected pin.</span>
<span class="sd">        It requires FirmataPlus to be loaded onto the arduino</span>

<span class="sd">        If the tone command is set to TONE_TONE, then the specified tone will be played.</span>

<span class="sd">        Else, if the tone command is TONE_NO_TONE, then any currently playing tone will be disabled.</span>

<span class="sd">        :param pin: Pin number</span>
<span class="sd">        :param tone_command: Either TONE_TONE, or TONE_NO_TONE</span>
<span class="sd">        :param frequency: Frequency of tone</span>
<span class="sd">        :param duration: Duration of tone in milliseconds</span>
<span class="sd">        :returns: No return value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># convert the integer values to bytes</span>
        <span class="k">if</span> <span class="n">tone_command</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="n">TONE_TONE</span><span class="p">:</span>
            <span class="c"># duration is specified</span>
            <span class="k">if</span> <span class="n">duration</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">tone_command</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">frequency</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">frequency</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">,</span>
                        <span class="n">duration</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">duration</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">tone_command</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span>
                        <span class="n">frequency</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">frequency</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="c"># turn off tone</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">tone_command</span><span class="p">,</span> <span class="n">pin</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">TONE_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PymataCore.send_reset"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.send_reset">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">send_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a Sysex reset command to the arduino</span>

<span class="sd">        :returns: No return value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">([</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SYSTEM_RESET</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PymataCore.servo_config"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.servo_config">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">servo_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">min_pulse</span><span class="o">=</span><span class="mi">544</span><span class="p">,</span> <span class="n">max_pulse</span><span class="o">=</span><span class="mi">2400</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure a pin as a servo pin. Set pulse min, max in ms.</span>
<span class="sd">        Use this method (not set_pin_mode) to configure a pin for servo</span>
<span class="sd">        operation.</span>

<span class="sd">        :param pin: Servo Pin.</span>
<span class="sd">        :param min_pulse: Min pulse width in ms.</span>
<span class="sd">        :param max_pulse: Max pulse width in ms.</span>
<span class="sd">        :returns: No return value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">pin</span><span class="p">,</span> <span class="n">min_pulse</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">min_pulse</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">,</span> <span class="n">max_pulse</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
                   <span class="n">max_pulse</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">]</span>

        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SERVO_CONFIG</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PymataCore.set_analog_latch"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.set_analog_latch">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">set_analog_latch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">threshold_type</span><span class="p">,</span> <span class="n">threshold_value</span><span class="p">,</span>
                               <span class="n">cb</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cb_type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method &quot;arms&quot; an analog pin for its data to be latched and saved</span>
<span class="sd">        in the latching table</span>
<span class="sd">        If a callback method is provided, when latching criteria is achieved,</span>
<span class="sd">        the callback function is called with latching data notification.</span>

<span class="sd">        Data returned in the callback list has the pin number as the</span>
<span class="sd">        first element,</span>

<span class="sd">        :param pin: Analog pin number</span>
<span class="sd">                    (value following an &#39;A&#39; designator, i.e. A5 = 5</span>
<span class="sd">        :param threshold_type: ANALOG_LATCH_GT | ANALOG_LATCH_LT  |</span>
<span class="sd">                               ANALOG_LATCH_GTE | ANALOG_LATCH_LTE</span>
<span class="sd">        :param threshold_value: numerical value - between 0 and 1023</span>
<span class="sd">        :param cb: callback method</span>
<span class="sd">        :param cb_type: Constants.CB_TYPE_DIRECT = direct call or</span>
<span class="sd">                        Constants.CB_TYPE_ASYNCIO = asyncio coroutine</span>
<span class="sd">        :returns: True if successful, False if parameter data is invalid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">Constants</span><span class="o">.</span><span class="n">LATCH_GT</span> <span class="o">&lt;=</span> <span class="n">threshold_type</span> <span class="o">&lt;=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">LATCH_LTE</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;A&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">threshold_value</span> <span class="o">&lt;=</span> <span class="mi">1023</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">latch_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Constants</span><span class="o">.</span><span class="n">LATCH_ARMED</span><span class="p">,</span> <span class="n">threshold_type</span><span class="p">,</span>
                                       <span class="n">threshold_value</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">cb_type</span><span class="p">]</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="PymataCore.set_digital_latch"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.set_digital_latch">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">set_digital_latch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">threshold_value</span><span class="p">,</span> <span class="n">cb</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                <span class="n">cb_type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method &quot;arms&quot; a digital pin for its data to be latched and</span>
<span class="sd">        saved in the latching table</span>
<span class="sd">        If a callback method is provided, when latching criteria is achieved,</span>
<span class="sd">        the callback function is called with latching data notification.</span>

<span class="sd">        Data returned in the callback list has the pin number as the</span>
<span class="sd">        first element,</span>

<span class="sd">        :param pin: Digital pin number</span>
<span class="sd">        :param threshold_value: 0 or 1</span>
<span class="sd">        :param cb: callback function</span>
<span class="sd">        :param cb_type: Constants.CB_TYPE_DIRECT = direct call or</span>
<span class="sd">                        Constants.CB_TYPE_ASYNCIO = asyncio coroutine</span>
<span class="sd">        :returns: True if successful, False if parameter data is invalid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">threshold_value</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;D&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">latch_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Constants</span><span class="o">.</span><span class="n">LATCH_ARMED</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">LATCH_EQ</span><span class="p">,</span>
                                   <span class="n">threshold_value</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">cb_type</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="PymataCore.set_pin_mode"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.set_pin_mode">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">set_pin_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin_number</span><span class="p">,</span> <span class="n">pin_state</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                           <span class="n">callback_type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method sets the pin mode for the specified pin.</span>
<span class="sd">        For Servo, use servo_config() instead.</span>

<span class="sd">        :param pin_number: Arduino Pin Number</span>
<span class="sd">        :param pin_state:INPUT/OUTPUT/ANALOG/PWM/</span>
<span class="sd">        :param callback: Optional: A reference to a call back function to be</span>
<span class="sd">                                   called when pin data value changes</span>
<span class="sd">        :param callback_type: direct call or asyncio await</span>
<span class="sd">        :returns: No return value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># There is a potential start up race condition when running pymata3.</span>
        <span class="c"># This is a workaround for that race condition</span>
        <span class="c">#</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">):</span>
            <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pin_state</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="n">INPUT</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">callback</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span><span class="o">.</span><span class="n">cb_type</span> <span class="o">=</span> <span class="n">callback_type</span>
            <span class="k">elif</span> <span class="n">pin_state</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="n">ANALOG</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">callback</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span><span class="o">.</span><span class="n">cb_type</span> <span class="o">=</span> <span class="n">callback_type</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span><span class="p">:</span>
                    <span class="n">log_string</span> <span class="o">=</span> <span class="s">&#39;set_pin_mode: callback ignored for &#39;</span> \
                                 <span class="s">&#39;pin state: &#39;</span> <span class="o">+</span> <span class="n">pin_state</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_string</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;{} {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;set_pin_mode: callback ignored for &#39;</span>
                                         <span class="s">&#39;pin state:&#39;</span><span class="p">,</span> <span class="n">pin_state</span><span class="p">))</span>

        <span class="n">pin_mode</span> <span class="o">=</span> <span class="n">pin_state</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SET_PIN_MODE</span><span class="p">,</span> <span class="n">pin_number</span><span class="p">,</span> <span class="n">pin_mode</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pin_state</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="n">ANALOG</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_analog_reporting</span><span class="p">(</span><span class="n">pin_number</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pin_state</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="n">INPUT</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_digital_reporting</span><span class="p">(</span><span class="n">pin_number</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="PymataCore.set_sampling_interval"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.set_sampling_interval">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">set_sampling_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method sends the desired sampling interval to Firmata.</span>
<span class="sd">        Note: Standard Firmata  will ignore any interval less than</span>
<span class="sd">              10 milliseconds</span>

<span class="sd">        :param interval: Integer value for desired sampling interval</span>
<span class="sd">                         in milliseconds</span>
<span class="sd">        :returns: No return value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">interval</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">interval</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SAMPLING_INTERVAL</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PymataCore.shutdown"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.shutdown">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method attempts an orderly shutdown</span>
<span class="sd">        If any exceptions are thrown, just ignore them.</span>

<span class="sd">        :returns: No return value</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Shutting down ...&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Shutting down ...&#39;</span><span class="p">)</span>

        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_reset</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PymataCore.sleep"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.sleep">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">sleep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sleep_time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is a proxy method for asyncio.sleep</span>

<span class="sd">        :param sleep_time: Sleep interval in seconds</span>
<span class="sd">        :returns: No return value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;sleep exception&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;sleep exception&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="PymataCore.sonar_config"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.sonar_config">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">sonar_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trigger_pin</span><span class="p">,</span> <span class="n">echo_pin</span><span class="p">,</span> <span class="n">cb</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                           <span class="n">ping_interval</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">max_distance</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">cb_type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure the pins,ping interval and maximum distance for an HC-SR04</span>
<span class="sd">        type device.</span>
<span class="sd">        Single pin configuration may be used. To do so, set both the trigger</span>
<span class="sd">        and echo pins to the same value.</span>
<span class="sd">        Up to a maximum of 6 SONAR devices is supported</span>
<span class="sd">        If the maximum is exceeded a message is sent to the console and the</span>
<span class="sd">        request is ignored.</span>
<span class="sd">        NOTE: data is measured in centimeters</span>

<span class="sd">        :param trigger_pin: The pin number of for the trigger (transmitter).</span>
<span class="sd">        :param echo_pin: The pin number for the received echo.</span>
<span class="sd">        :param cb: optional callback function to report sonar data changes</span>
<span class="sd">        :param ping_interval: Minimum interval between pings. Lowest number</span>
<span class="sd">                              to use is 33 ms.Max is 127</span>
<span class="sd">        :param max_distance: Maximum distance in cm. Max is 200.</span>
<span class="sd">        :param cb_type: Constants.CB_TYPE_DIRECT = direct call or</span>
<span class="sd">                        Constants.CB_TYPE_ASYNCIO = asyncio coroutine</span>
<span class="sd">        :returns: No return value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># if there is an entry for the trigger pin in existence, just exit</span>
        <span class="k">if</span> <span class="n">trigger_pin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">max_distance</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">max_distance</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">max_distance_lsb</span> <span class="o">=</span> <span class="n">max_distance</span> <span class="o">&amp;</span> <span class="mh">0x7f</span>
        <span class="n">max_distance_msb</span> <span class="o">=</span> <span class="n">max_distance</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">trigger_pin</span><span class="p">,</span> <span class="n">echo_pin</span><span class="p">,</span> <span class="n">ping_interval</span><span class="p">,</span> <span class="n">max_distance_lsb</span><span class="p">,</span>
                <span class="n">max_distance_msb</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_pin_mode</span><span class="p">(</span><span class="n">trigger_pin</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">SONAR</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">INPUT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_pin_mode</span><span class="p">(</span><span class="n">echo_pin</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">SONAR</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">INPUT</span><span class="p">)</span>
        <span class="c"># update the ping data map for this pin</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&#39;sonar_config: maximum number of &#39;</span>
                                  <span class="s">&#39;devices assigned - ignoring request&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;sonar_config: maximum number of devices assigned&#39;</span>
                      <span class="s">&#39; - ignoring request&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="p">[</span><span class="n">trigger_pin</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cb</span><span class="p">,</span> <span class="n">cb_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SONAR_CONFIG</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PymataCore.sonar_data_retrieve"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.sonar_data_retrieve">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">sonar_data_retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trigger_pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve Ping (HC-SR04 type) data. The data is presented as a</span>
<span class="sd">        dictionary.</span>
<span class="sd">        The &#39;key&#39; is the trigger pin specified in sonar_config()</span>
<span class="sd">        and the &#39;data&#39; is the current measured distance (in centimeters)</span>
<span class="sd">        for that pin. If there is no data, the value is set to None.</span>

<span class="sd">        :param trigger_pin: key into sonar data map</span>
<span class="sd">        :returns: active_sonar_map</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># sonar_pin_entry = self.active_sonar_map[pin]</span>
        <span class="n">sonar_pin_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">trigger_pin</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span>
</div>
<div class="viewcode-block" id="PymataCore.stepper_config"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.stepper_config">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">stepper_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps_per_revolution</span><span class="p">,</span> <span class="n">stepper_pins</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure stepper motor prior to operation.</span>
<span class="sd">        This is a FirmataPlus feature.</span>

<span class="sd">        :param steps_per_revolution: number of steps per motor revolution</span>
<span class="sd">        :param stepper_pins: a list of control pin numbers - either 4 or 2</span>
<span class="sd">        :returns: No return value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">STEPPER_CONFIGURE</span><span class="p">,</span> <span class="n">steps_per_revolution</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
                <span class="n">steps_per_revolution</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stepper_pins</span><span class="p">)):</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stepper_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">])</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">STEPPER_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PymataCore.stepper_step"><a class="viewcode-back" href="../../pymata_aio.html#pymata_aio.pymata_core.PymataCore.stepper_step">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">stepper_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor_speed</span><span class="p">,</span> <span class="n">number_of_steps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move a stepper motor for the number of steps at the specified speed</span>
<span class="sd">        This is a FirmataPlus feature.</span>

<span class="sd">        :param motor_speed: 21 bits of data to set motor speed</span>
<span class="sd">        :param number_of_steps: 14 bits for number of steps &amp; direction</span>
<span class="sd">                                positive is forward, negative is reverse</span>
<span class="sd">        :returns: No return value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">number_of_steps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">abs_number_of_steps</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">number_of_steps</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">STEPPER_STEP</span><span class="p">,</span> <span class="n">motor_speed</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
                <span class="p">(</span><span class="n">motor_speed</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">motor_speed</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">,</span>
                <span class="n">abs_number_of_steps</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">abs_number_of_steps</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">,</span> <span class="n">direction</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">STEPPER_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</div>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">_command_dispatcher</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private method.</span>
<span class="sd">        It continually accepts and interprets data coming from Firmata,and then</span>
<span class="sd">        dispatches the correct handler to process the data.</span>

<span class="sd">        :returns: This method never returns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># sysex commands are assembled into this list for processing</span>
        <span class="n">sysex</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">next_command_byte</span> <span class="o">=</span> <span class="n">await</span>  <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="c"># if this is a SYSEX command, then assemble the entire</span>
                <span class="c"># command process it</span>
                <span class="k">if</span> <span class="n">next_command_byte</span> <span class="o">==</span> <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">START_SYSEX</span><span class="p">:</span>
                    <span class="k">while</span> <span class="n">next_command_byte</span> <span class="o">!=</span> <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">END_SYSEX</span><span class="p">:</span>
                        <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
                        <span class="n">next_command_byte</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="n">sysex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_command_byte</span><span class="p">)</span>
                    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_dictionary</span><span class="p">[</span><span class="n">sysex</span><span class="p">[</span><span class="mi">0</span><span class="p">]](</span><span class="n">sysex</span><span class="p">)</span>
                    <span class="n">sysex</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
                <span class="c"># if this is an analog message, process it.</span>
                <span class="k">elif</span> <span class="mh">0xE0</span> <span class="o">&lt;=</span> <span class="n">next_command_byte</span> <span class="o">&lt;</span> <span class="mh">0xEF</span><span class="p">:</span>
                    <span class="c"># analog message</span>
                    <span class="c"># assemble the entire analog message in command</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c"># get the pin number for the message</span>
                    <span class="n">pin</span> <span class="o">=</span> <span class="n">next_command_byte</span> <span class="o">&amp;</span> <span class="mh">0x0f</span>
                    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
                    <span class="c"># get the next 2 bytes for the command</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_data</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="c"># process the analog message</span>
                    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analog_message</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                <span class="c"># handle the digital message</span>
                <span class="k">elif</span> <span class="mh">0x90</span> <span class="o">&lt;=</span> <span class="n">next_command_byte</span> <span class="o">&lt;=</span> <span class="mh">0x9F</span><span class="p">:</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">pin</span> <span class="o">=</span> <span class="n">next_command_byte</span> <span class="o">&amp;</span> <span class="mh">0x0f</span>
                    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_data</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_digital_message</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                <span class="c"># handle all other messages by looking them up in the</span>
                <span class="c"># command dictionary</span>
                <span class="k">elif</span> <span class="n">next_command_byte</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_dictionary</span><span class="p">:</span>
                    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_dictionary</span><span class="p">[</span><span class="n">next_command_byte</span><span class="p">]()</span>
                    <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># we need to yield back to the loop</span>
                    <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="c"># should never get here</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                <span class="k">raise</span>  <span class="c"># re-raise exception.</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Firmata message handlers</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_analog_mapping_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        It is a message handler for the analog mapping response message</span>

<span class="sd">        :param data: response data</span>
<span class="sd">        :returns: none - but saves the response</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_RESPONSE</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_analog_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        It is a message handler for analog messages.</span>

<span class="sd">        :param data: message data</span>
<span class="sd">        :returns: None - but saves the data in the pins structure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pin</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">MSB</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">LSB</span><span class="p">]</span>
        <span class="c"># if self.analog_pins[pin].current_value != value:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">current_value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">:</span>
            <span class="c"># append pin number to return value and return as a list</span>
            <span class="c"># self.analog_pins[pin].cb(value)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">pin</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb_type</span><span class="p">:</span>
                <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
                <span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c"># is there a latch entry for this pin?</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;A&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">latch_map</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_latch_data</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_capability_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        It is a message handler for capability report responses.</span>

<span class="sd">        :param data: capability report</span>
<span class="sd">        :returns: None - but report is saved</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_RESPONSE</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_digital_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        It is a message handler for Digital Messages.</span>

<span class="sd">        :param data: digital message</span>

<span class="sd">        :returns: None - but update is saved in pins structure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">port_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">MSB</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> \
                    <span class="n">data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">LSB</span><span class="p">]</span>
        <span class="n">pin</span> <span class="o">=</span> <span class="n">port</span> <span class="o">*</span> <span class="mi">8</span>
        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">pin</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">))):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">current_value</span> <span class="o">=</span> <span class="n">port_data</span> <span class="o">&amp;</span> <span class="mh">0x01</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">pin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">current_value</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb_type</span><span class="p">:</span>
                    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># self.digital_pins[pin].cb(data)</span>
                    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
                    <span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

                <span class="c"># is there a latch entry for this pin?</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;D&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">latch_map</span><span class="p">:</span>
                    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_latch_data</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">port_data</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
            <span class="n">port_data</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_encoder_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        It handles encoder data messages.</span>

<span class="sd">        :param data: encoder data</span>
<span class="sd">        :returns: None - but update is saved in the digital pins structure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># strip off sysex start and end</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pin</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hall_encoder</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">MSB</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span>
                      <span class="n">data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">LSB</span><span class="p">])</span>
            <span class="c"># set value so that it shows positive and negative values</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">8192</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">-=</span> <span class="mi">16384</span>
            <span class="c"># if this value is different that is what is already in the</span>
            <span class="c"># table store it and check for callback</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">current_value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">current_value</span> <span class="o">=</span> <span class="n">val</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">:</span>
                    <span class="c"># self.digital_pins[pin].cb([pin, val])</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb_type</span><span class="p">:</span>
                        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c"># self.digital_pins[pin].cb(data)</span>
                        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
                        <span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hall_data</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span>
                                                            <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">])]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb_type</span><span class="p">:</span>
                <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">(</span><span class="n">hall_data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># self.digital_pins[pin].cb(data)</span>
                <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
                <span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">,</span> <span class="n">hall_data</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_i2c_reply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        It handles replies to i2c_read requests. It stores the data</span>
<span class="sd">        for each i2c device address in a dictionary called i2c_map.</span>
<span class="sd">        The data may be retrieved via a polling call to i2c_get_read_data().</span>
<span class="sd">        It a callback was specified in pymata.i2c_read, the raw data is sent</span>
<span class="sd">        through the callback</span>

<span class="sd">        :param data: raw data returned from i2c device</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># remove the start and end sysex commands from the data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">reply_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># reassemble the data from the firmata 2 byte format</span>
        <span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span>

        <span class="c"># if we have an entry in the i2c_map, proceed</span>
        <span class="k">if</span> <span class="n">address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="p">:</span>
            <span class="c"># get 2 bytes, combine them and append to reply data list</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">combined_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span>
                <span class="n">reply_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">combined_data</span><span class="p">)</span>

            <span class="c"># place the data in the i2c map without storing the address byte or</span>
            <span class="c">#  register byte (returned data only)</span>
            <span class="n">map_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
            <span class="n">map_entry</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reply_data</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="n">map_entry</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">map_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;callback&#39;</span><span class="p">)</span>
            <span class="n">cb_type</span> <span class="o">=</span> <span class="n">map_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;callback_type&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cb</span><span class="p">:</span>
                <span class="c"># send everything, including address and register bytes back</span>
                <span class="c"># to caller</span>
                <span class="k">if</span> <span class="n">cb_type</span><span class="p">:</span>
                    <span class="n">await</span> <span class="n">cb</span><span class="p">(</span><span class="n">reply_data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
                    <span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">reply_data</span><span class="p">)</span>
                <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_pin_state_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        It handles pin state query response messages.</span>

<span class="sd">        :param data: Pin state message</span>
<span class="sd">        :returns: None - but response is saved</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_RESPONSE</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_report_firmware</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sysex_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        This method handles the sysex &#39;report firmware&#39; command sent by</span>
<span class="sd">        Firmata (0x79).</span>
<span class="sd">        It assembles the firmware version by concatenating the major and</span>
<span class="sd">         minor version number components and</span>
<span class="sd">        the firmware identifier into a string.</span>
<span class="sd">        e.g. &quot;2.3 StandardFirmata.ino&quot;</span>

<span class="sd">        :param sysex_data: Sysex data sent from Firmata</span>
<span class="sd">        :returns: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># first byte after command is major number</span>
        <span class="n">major</span> <span class="o">=</span> <span class="n">sysex_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">version_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">major</span><span class="p">)</span>

        <span class="c"># next byte is minor number</span>
        <span class="n">minor</span> <span class="o">=</span> <span class="n">sysex_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c"># append a dot to major number</span>
        <span class="n">version_string</span> <span class="o">+=</span> <span class="s">&#39;.&#39;</span>

        <span class="c"># append minor number</span>
        <span class="n">version_string</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">minor</span><span class="p">)</span>
        <span class="c"># add a space after the major and minor numbers</span>
        <span class="n">version_string</span> <span class="o">+=</span> <span class="s">&#39; &#39;</span>

        <span class="c"># slice the identifier - from the first byte after the minor</span>
        <span class="c">#  number up until, but not including the END_SYSEX byte</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">sysex_data</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c"># convert the identifier to printable text and add each character</span>
        <span class="c"># to the version string</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">version_string</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="c"># store the value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">]</span> <span class="o">=</span> <span class="n">version_string</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_report_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        This method reads the following 2 bytes after the report version</span>
<span class="sd">        command (0xF9 - non sysex).</span>
<span class="sd">        The first byte is the major number and the second byte is the</span>
<span class="sd">        minor number.</span>

<span class="sd">        :returns: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># get next two bytes</span>
        <span class="n">major</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">version_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">major</span><span class="p">)</span>
        <span class="n">minor</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">version_string</span> <span class="o">+=</span> <span class="s">&#39;.&#39;</span>
        <span class="n">version_string</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">minor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">]</span> <span class="o">=</span> <span class="n">version_string</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_sonar_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method handles the incoming sonar data message and stores</span>
<span class="sd">        the data in the response table.</span>

<span class="sd">        :param data: Message data from Firmata</span>
<span class="sd">        :returns: No return value.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># strip off sysex start and end</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pin_number</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">MSB</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span>
                  <span class="n">data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">LSB</span><span class="p">])</span>

        <span class="n">sonar_pin_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># check if value changed since last reading</span>
            <span class="k">if</span> <span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span>
                <span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">sonar_pin_entry</span>
                <span class="c"># Do a callback if one is specified in the table</span>
                <span class="k">if</span> <span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">await</span> <span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]([</span><span class="n">pin_number</span><span class="p">,</span> <span class="n">val</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c"># sonar_pin_entry[0]([pin_number, val])</span>
                        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
                        <span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pin_number</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="c"># update the data in the table with latest value</span>
        <span class="c"># sonar_pin_entry[1] = val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">sonar_pin_entry</span>

        <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_string_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        It is the message handler for String data messages that will be</span>
<span class="sd">        printed to the console.</span>
<span class="sd">        :param data:  message</span>
<span class="sd">        :returns: None - message is sent to console</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reply</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">reply_data</span> <span class="o">=</span> <span class="n">x</span>
            <span class="k">if</span> <span class="n">reply_data</span><span class="p">:</span>
                <span class="n">reply</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">reply_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    utilities</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_check_latch_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private utility method.</span>
<span class="sd">        When a data change message is received this method checks to see if</span>
<span class="sd">        latching needs to be processed</span>

<span class="sd">        :param key: encoded pin number</span>
<span class="sd">        :param data: data change</span>
<span class="sd">        :returns: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">process</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">latching_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latch_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">latching_entry</span><span class="p">[</span><span class="n">Constants</span><span class="o">.</span><span class="n">LATCH_STATE</span><span class="p">]</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="n">LATCH_ARMED</span><span class="p">:</span>
            <span class="c"># Has the latching criteria been met</span>
            <span class="k">if</span> <span class="n">latching_entry</span><span class="p">[</span><span class="n">Constants</span><span class="o">.</span><span class="n">LATCHED_THRESHOLD_TYPE</span><span class="p">]</span> <span class="o">==</span> \
                    <span class="n">Constants</span><span class="o">.</span><span class="n">LATCH_EQ</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="n">latching_entry</span><span class="p">[</span><span class="n">Constants</span><span class="o">.</span><span class="n">LATCH_DATA_TARGET</span><span class="p">]:</span>
                    <span class="n">process</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">latching_entry</span><span class="p">[</span><span class="n">Constants</span><span class="o">.</span><span class="n">LATCHED_THRESHOLD_TYPE</span><span class="p">]</span> <span class="o">==</span> \
                    <span class="n">Constants</span><span class="o">.</span><span class="n">LATCH_GT</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data</span> <span class="o">&gt;</span> <span class="n">latching_entry</span><span class="p">[</span><span class="n">Constants</span><span class="o">.</span><span class="n">LATCH_DATA_TARGET</span><span class="p">]:</span>
                    <span class="n">process</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">latching_entry</span><span class="p">[</span><span class="n">Constants</span><span class="o">.</span><span class="n">LATCHED_THRESHOLD_TYPE</span><span class="p">]</span> <span class="o">==</span> \
                    <span class="n">Constants</span><span class="o">.</span><span class="n">LATCH_GTE</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data</span> <span class="o">&gt;=</span> <span class="n">latching_entry</span><span class="p">[</span><span class="n">Constants</span><span class="o">.</span><span class="n">LATCH_DATA_TARGET</span><span class="p">]:</span>
                    <span class="n">process</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">latching_entry</span><span class="p">[</span><span class="n">Constants</span><span class="o">.</span><span class="n">LATCHED_THRESHOLD_TYPE</span><span class="p">]</span> <span class="o">==</span> \
                    <span class="n">Constants</span><span class="o">.</span><span class="n">LATCH_LT</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data</span> <span class="o">&lt;</span> <span class="n">latching_entry</span><span class="p">[</span><span class="n">Constants</span><span class="o">.</span><span class="n">LATCH_DATA_TARGET</span><span class="p">]:</span>
                    <span class="n">process</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">latching_entry</span><span class="p">[</span><span class="n">Constants</span><span class="o">.</span><span class="n">LATCHED_THRESHOLD_TYPE</span><span class="p">]</span> <span class="o">==</span> \
                    <span class="n">Constants</span><span class="o">.</span><span class="n">LATCH_LTE</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data</span> <span class="o">&lt;=</span> <span class="n">latching_entry</span><span class="p">[</span><span class="n">Constants</span><span class="o">.</span><span class="n">LATCH_DATA_TARGET</span><span class="p">]:</span>
                    <span class="n">process</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">process</span><span class="p">:</span>
                <span class="n">latching_entry</span><span class="p">[</span><span class="n">Constants</span><span class="o">.</span><span class="n">LATCHED_DATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
                <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_latching</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">latching_entry</span><span class="p">)</span>

    <span class="c"># noinspection PyMethodMayBeStatic</span>
    <span class="k">def</span> <span class="nf">_discover_port</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private utility method.</span>
<span class="sd">        This method attempts to discover the com port that the arduino</span>
<span class="sd">        is connected to.</span>

<span class="sd">        :returns: Detected Comport</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># if MAC get list of ports</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;darwin&#39;</span><span class="p">):</span>
            <span class="n">locations</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s">&#39;/dev/tty.[usb*]*&#39;</span><span class="p">)</span>
            <span class="n">locations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;end&#39;</span><span class="p">)</span>
        <span class="c"># for everyone else, here is a list of possible ports</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">locations</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;dev/ttyACM0&#39;</span><span class="p">,</span> <span class="s">&#39;/dev/ttyACM0&#39;</span><span class="p">,</span> <span class="s">&#39;/dev/ttyACM1&#39;</span><span class="p">,</span>
                         <span class="s">&#39;/dev/ttyACM2&#39;</span><span class="p">,</span> <span class="s">&#39;/dev/ttyACM3&#39;</span><span class="p">,</span> <span class="s">&#39;/dev/ttyACM4&#39;</span><span class="p">,</span>
                         <span class="s">&#39;/dev/ttyACM5&#39;</span><span class="p">,</span> <span class="s">&#39;/dev/ttyUSB0&#39;</span><span class="p">,</span> <span class="s">&#39;/dev/ttyUSB1&#39;</span><span class="p">,</span>
                         <span class="s">&#39;/dev/ttyUSB2&#39;</span><span class="p">,</span> <span class="s">&#39;/dev/ttyUSB3&#39;</span><span class="p">,</span> <span class="s">&#39;/dev/ttyUSB4&#39;</span><span class="p">,</span>
                         <span class="s">&#39;/dev/ttyUSB5&#39;</span><span class="p">,</span> <span class="s">&#39;/dev/ttyUSB6&#39;</span><span class="p">,</span> <span class="s">&#39;/dev/ttyUSB7&#39;</span><span class="p">,</span>
                         <span class="s">&#39;/dev/ttyUSB8&#39;</span><span class="p">,</span> <span class="s">&#39;/dev/ttyUSB9&#39;</span><span class="p">,</span>
                         <span class="s">&#39;/dev/ttyUSB10&#39;</span><span class="p">,</span>
                         <span class="s">&#39;/dev/ttyS0&#39;</span><span class="p">,</span> <span class="s">&#39;/dev/ttyS1&#39;</span><span class="p">,</span> <span class="s">&#39;/dev/ttyS2&#39;</span><span class="p">,</span>
                         <span class="s">&#39;/dev/tty.usbserial&#39;</span><span class="p">,</span> <span class="s">&#39;/dev/tty.usbmodem&#39;</span><span class="p">,</span> <span class="s">&#39;com2&#39;</span><span class="p">,</span>
                         <span class="s">&#39;com3&#39;</span><span class="p">,</span> <span class="s">&#39;com4&#39;</span><span class="p">,</span> <span class="s">&#39;com5&#39;</span><span class="p">,</span> <span class="s">&#39;com6&#39;</span><span class="p">,</span> <span class="s">&#39;com7&#39;</span><span class="p">,</span> <span class="s">&#39;com8&#39;</span><span class="p">,</span>
                         <span class="s">&#39;com9&#39;</span><span class="p">,</span> <span class="s">&#39;com10&#39;</span><span class="p">,</span> <span class="s">&#39;com11&#39;</span><span class="p">,</span> <span class="s">&#39;com12&#39;</span><span class="p">,</span> <span class="s">&#39;com13&#39;</span><span class="p">,</span>
                         <span class="s">&#39;com14&#39;</span><span class="p">,</span> <span class="s">&#39;com15&#39;</span><span class="p">,</span> <span class="s">&#39;com16&#39;</span><span class="p">,</span> <span class="s">&#39;com17&#39;</span><span class="p">,</span> <span class="s">&#39;com18&#39;</span><span class="p">,</span>
                         <span class="s">&#39;com19&#39;</span><span class="p">,</span> <span class="s">&#39;com20&#39;</span><span class="p">,</span> <span class="s">&#39;com21&#39;</span><span class="p">,</span> <span class="s">&#39;com1&#39;</span><span class="p">,</span> <span class="s">&#39;end&#39;</span>
                         <span class="p">]</span>

        <span class="n">detected</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">locations</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">serialport</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="mi">57600</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">detected</span> <span class="o">=</span> <span class="n">device</span>
                <span class="n">serialport</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">device</span> <span class="o">==</span> <span class="s">&#39;end&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                            <span class="s">&#39;Unable to find Serial Port, Please plug in &#39;</span>
                            <span class="s">&#39;cable or check cable connections.&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Unable to find Serial Port, Please plug in &#39;</span>
                              <span class="s">&#39;cable or check cable connections.&#39;</span><span class="p">)</span>
                    <span class="n">detected</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="nb">exit</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span><span class="p">:</span>
            <span class="n">log_string</span> <span class="o">=</span> <span class="s">&#39;Using COM Port: &#39;</span> <span class="o">+</span> <span class="n">detected</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_string</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;{}{}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;Using COM Port:&#39;</span><span class="p">,</span> <span class="n">detected</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">detected</span>

    <span class="c"># noinspection PyMethodMayBeStatic</span>
    <span class="k">def</span> <span class="nf">_format_capability_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private utility method.</span>
<span class="sd">        This method formats a capability report if the user wishes to</span>
<span class="sd">        send it to the console.</span>
<span class="sd">        If log_output = True, no output is generated</span>

<span class="sd">        :param data: Capability report</span>
<span class="sd">        :returns: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">pin_modes</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s">&#39;Digital_Input&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s">&#39;Digital_Output&#39;</span><span class="p">,</span>
                         <span class="mi">2</span><span class="p">:</span> <span class="s">&#39;Analog&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s">&#39;PWM&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="s">&#39;Servo&#39;</span><span class="p">,</span>
                         <span class="mi">5</span><span class="p">:</span> <span class="s">&#39;Shift&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="s">&#39;I2C&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span> <span class="s">&#39;One Wire&#39;</span><span class="p">,</span>
                         <span class="mi">8</span><span class="p">:</span> <span class="s">&#39;Stepper&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">:</span> <span class="s">&#39;Encoder&#39;</span><span class="p">}</span>
            <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">pin</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Capability Report&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;-----------------</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="c"># get index of next end marker</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;{} {}{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;Pin&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">pin</span><span class="p">),</span> <span class="s">&#39;:&#39;</span><span class="p">))</span>
                <span class="k">while</span> <span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">127</span><span class="p">:</span>
                    <span class="n">mode_str</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                    <span class="n">pin_mode</span> <span class="o">=</span> <span class="n">pin_modes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                    <span class="n">mode_str</span> <span class="o">+=</span> <span class="n">pin_mode</span>
                    <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">bits</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;{:&gt;5}{}{} {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;  &#39;</span><span class="p">,</span> <span class="n">mode_str</span><span class="p">,</span> <span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">bits</span><span class="p">))</span>
                    <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">pin</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_process_latching</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">latching_entry</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private utility method.</span>
<span class="sd">        This method process latching events and either returns them via</span>
<span class="sd">        callback or stores them in the latch map</span>

<span class="sd">        :param key: Encoded pin</span>
<span class="sd">        :param latching_entry: a latch table entry</span>
<span class="sd">        :returns: Callback or store data in latch map</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">latching_entry</span><span class="p">[</span><span class="n">Constants</span><span class="o">.</span><span class="n">LATCH_CALLBACK</span><span class="p">]:</span>
            <span class="c"># auto clear entry and execute the callback</span>

            <span class="c"># noinspection PyPep8</span>
            <span class="n">latching_entry</span><span class="p">[</span><span class="n">Constants</span><span class="o">.</span><span class="n">LATCH_CALLBACK</span><span class="p">]</span> \
                <span class="p">([</span><span class="n">key</span><span class="p">,</span> <span class="n">latching_entry</span><span class="p">[</span><span class="n">Constants</span><span class="o">.</span><span class="n">LATCHED_DATA</span><span class="p">],</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">latch_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">updated_latch_entry</span> <span class="o">=</span> <span class="n">latching_entry</span>
            <span class="n">updated_latch_entry</span><span class="p">[</span><span class="n">Constants</span><span class="o">.</span><span class="n">LATCH_STATE</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">Constants</span><span class="o">.</span><span class="n">LATCH_LATCHED</span>
            <span class="n">updated_latch_entry</span><span class="p">[</span><span class="n">Constants</span><span class="o">.</span><span class="n">LATCHED_DATA</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">latching_entry</span><span class="p">[</span><span class="n">Constants</span><span class="o">.</span><span class="n">LATCHED_DATA</span><span class="p">]</span>
            <span class="c"># time stamp it</span>
            <span class="n">updated_latch_entry</span><span class="p">[</span><span class="n">Constants</span><span class="o">.</span><span class="n">LATCHED_TIME_STAMP</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">latch_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_latch_entry</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_send_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private utility method.</span>
<span class="sd">        The method sends a non-sysex command to Firmata.</span>

<span class="sd">        :param command:  command data</span>
<span class="sd">        :returns: length of data sent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">send_message</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">command</span><span class="p">:</span>
            <span class="n">send_message</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">send_message</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">except</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_output</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&#39;cannot send command&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;cannot send command&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_send_sysex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sysex_command</span><span class="p">,</span> <span class="n">sysex_data</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private utility method.</span>
<span class="sd">        This method sends a sysex command to Firmata.</span>

<span class="sd">        :param sysex_command: sysex command</span>
<span class="sd">        :param sysex_data: data for command</span>
<span class="sd">        :returns : No return value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sysex_data</span><span class="p">:</span>
            <span class="n">sysex_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># convert the message command and data to characters</span>
        <span class="n">sysex_message</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">START_SYSEX</span><span class="p">)</span>
        <span class="n">sysex_message</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">sysex_command</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sysex_data</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">sysex_data</span><span class="p">:</span>
                <span class="n">sysex_message</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">sysex_message</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">END_SYSEX</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">sysex_message</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_wait_for_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_command</span><span class="p">,</span> <span class="n">number_of_bytes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private utility method.</span>
<span class="sd">        This method accumulates the requested number of bytes and</span>
<span class="sd">        then returns the full command</span>

<span class="sd">        :param current_command:  command id</span>
<span class="sd">        :param number_of_bytes:  how many bytes to wait for</span>
<span class="sd">        :returns: command</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="n">number_of_bytes</span><span class="p">:</span>
            <span class="n">next_command_byte</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">current_command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_command_byte</span><span class="p">)</span>
            <span class="n">number_of_bytes</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">current_command</span></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Alan Yorinks.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>